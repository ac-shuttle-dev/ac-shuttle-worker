# AC Shuttle Webhook Worker – Product Requirements Document

## 1. Overview

AC Shuttle relies on Framer-hosted forms to collect ride requests from customers. The Cloudflare Worker must translate each submission into coordinated actions:

1. authenticate and validate the inbound webhook,
2. persist the request to Google Sheets for operations tracking,
3. notify the owner via a structured email that includes one-time accept/deny links, and
4. send a customer-facing response when the owner takes action.

The system must be extensible to support future flows (e.g., price adjustments), provide observability, and guard against abuse.

## 2. Goals & Non-Goals

### Goals
- Guarantee that only authentic Framer webhooks are processed (HMAC verification).
- Prevent replay and rate-limit burst submissions.
- Persist each transaction into a primary and backup Google Sheet with a deterministic transaction ID.
- Generate templated emails for owner and customer, tagged for easy filtering.
- Provide one-time accept/deny links that update state, trigger customer emails, and render confirmation pages.
- Structure the codebase into **Security**, **Coordination**, and **Messaging** layers for clarity and future extensibility.
- Offer documentation and configuration guidance for adding new flows.

### Non-Goals
- Building a full CRM or multi-step workflow beyond accept/deny.
- Implementing complex front-end experiences; confirmation pages may stay minimal HTML.
- Providing API surfaces beyond what Framer and Resend require.

## 3. Layered Architecture

```
┌──────────────────────────────┐
│        Security Layer        │
│  - Framer HMAC verification  │
│  - Rate limiting             │
│  - Duplicate detection       │
│  - CORS / method enforcement │
└──────────────┬───────────────┘
               │
┌──────────────▼───────────────┐
│      Coordination Layer       │
│  - Compute transaction ID     │
│  - Persist to Sheets          │
│  - Generate owner/customer    │
│    action descriptors         │
│  - Manage tokens & state      │
└──────────────┬───────────────┘
               │
┌──────────────▼───────────────┐
│        Messaging Layer        │
│  - Render email bodies        │
│  - Call Resend API            │
│  - Apply tags/labels          │
│  - Expose utility for future  │
│    channels (SMS, etc.)       │
└──────────────────────────────┘
```

Each layer exposes a narrow interface:
- **Security**: `validateRequest(request, env)` → returns normalized payload or error.
- **Coordination**: `handleSubmission(context)`; `handleOwnerDecision(context)`.
- **Messaging**: `sendOwnerAlert(details)`; `sendCustomerNotification(details)`.

## 4. Data Model

### Transaction ID
- Deterministic SHA-256 hash of: `customer_name`, `start_location`, `end_location`, `pickup_time`, `requested_at`, `email`.
- Used as the key for Sheets rows, rate limiting, and token storage.

### Sheets Schema
| Column | Description |
| --- | --- |
| `transaction_id` | Deterministic hash generated by coordination layer |
| `submission_id` | Framer-provided webhook submission identifier |
| `received_at` | ISO timestamp when the worker ingested the submission |
| `customer_name` | Passenger name extracted from the payload |
| `customer_email` | Passenger email |
| `customer_phone` | Passenger phone, stored as literal text (no formulas) |
| `pickup_location` | Pick-up location |
| `dropoff_location` | Drop-off location |
| `pickup_time` | Requested pickup timestamp |
| `estimated_distance` | Provided distance string |
| `estimated_duration` | Provided duration string |
| `passenger_count` | Passenger count |
| `quoted_price` | Submitted fare/price |
| `vehicle_type` | Optional vehicle preference |
| `customer_notes` | Additional notes supplied by the passenger |
| `driver_contact_name` | Driver / dispatcher name sourced from env vars |
| `driver_contact_email` | Driver / dispatcher email |
| `driver_contact_phone` | Driver / dispatcher phone (literal text) |
| `status` | Operational status column (defaults to `Pending Review`) |
| `raw_payload` | JSON snapshot of the original submission |

Both primary and backup sheets share the schema. Backup may live in a different spreadsheet ID for redundancy.

### Token Storage (KV/Durable Object)
- Key: `token:${tokenId}`
- Value: serialized JSON `{ transactionId, action: "accepted" | "denied", expiresAt, usedAt }`
- TTL: configurable via `TOKEN_TTL_MINUTES` (default 60 minutes).

### Rate Limiting Records (KV)
- Key: `rate:${email}:${bucketTimestamp}`
- Value: request count for the minute bucket.
- Limits: `RATE_LIMIT_MAX_REQUESTS` (default 10) per `RATE_LIMIT_WINDOW_SECONDS` (default 60).

## 5. External Integrations

### Framer
- Verifies requests via HMAC signature (`framer-signature`, `framer-webhook-submission-id`).
- On `502` from worker Framer will retry; once customer notification is sent we must return `200`.

### Resend
- Requires verified sending domain(s). Currently: `nadim@perfectpages.org` (verify domain) or fallback to `onboarding@resend.dev` for testing.
- Support `tags`, `bcc`, `reply_to`, and `headers`. We will prefix customer subjects with `AC-Accept` / `AC-Deny` and include tags for filtering.

### Google Sheets
- Detailed setup instructions live in `docs/GOOGLE_SHEETS_SETUP.md`.
- Service account with `spreadsheets` scope. JSON credentials stored in secret `GOOGLE_SERVICE_ACCOUNT`.
- Environment variables:
  - `GOOGLE_SHEET_ID_PRIMARY`
  - `GOOGLE_SHEET_ID_BACKUP`
  - `GOOGLE_SHEET_RANGE_PRIMARY` (optional, default `Sheet1!A:Z`)
  - `GOOGLE_SHEET_RANGE_BACKUP`
- All writes performed via Sheets REST API `spreadsheets.values.append` and `values.update`.

## 6. Configuration & Environment Variables

| Variable | Purpose |
| --- | --- |
| `WEBHOOK_SECRET` | Framer HMAC secret |
| `RESEND_API_KEY` | Resend API token |
| `OWNER_EMAIL` | New Passenger Alert recipient |
| `CUSTOMER_FROM_EMAIL` | Verified sender address for *all* outbound email (owner + customer) |
| `DRIVER_CONTACT_NAME` / `DRIVER_CONTACT_EMAIL` / `DRIVER_CONTACT_PHONE` | Inserted into acceptance copy |
| `RESEND_DRY_RUN` | Toggle actual Resend calls |
| `VERBOSE_LOGGING` | Emit detailed logs |
| `GOOGLE_SERVICE_ACCOUNT` | JSON credentials (secret) |
| `GOOGLE_SHEET_ID_PRIMARY` | Primary sheet ID |
| `GOOGLE_SHEET_ID_BACKUP` | Backup sheet ID |
| `GOOGLE_SHEET_RANGE_PRIMARY` / `GOOGLE_SHEET_RANGE_BACKUP` | Optional overrides |
| `TOKEN_TTL_MINUTES` | Accept/deny token lifetime (default 60) |
| `RATE_LIMIT_WINDOW_SECONDS` | Sliding window size (default 60) |
| `RATE_LIMIT_MAX_REQUESTS` | Allowed submissions per window (default 10) |

## 7. Messaging Templates

The `flows/booking.json` file acts as the canonical configuration. It defines:
- required fields (for validation),
- owner email subject/tags and action links,
- customer templates with subject prefixes and tags, and
- future overrides for new flows.

Documentation will instruct future contributors to add new flow configs in `flows/` and extend the coordination layer to select flows by form identifier or other criteria.

## 8. Confirmation Pages

- Owner accept/deny endpoints render minimal HTML pages indicating success or failure (`200` / `400`).
- Include reference data (customer name, pickup time) to reassure the owner.
- Optional meta refresh or CTA back to internal tools can be configured later.

## 9. Phase Breakdown

### Phase 0 – Documentation & Structure (current)
- Create PRD, flow config placeholder, directory scaffolding.
- Document environment variables and verification steps.

### Phase 1 – Security Layer Enhancements
- Implement dedicated module for HMAC verification, rate limiting, duplicate detection.
- Return `429` with friendly message when rate limit exceeded.
- Unit tests around HMAC + rate limiter.

### Phase 2 – Coordination Layer Foundations
- Compute transaction ID and persist to primary & backup Sheets.
- Append audit entry for submission received.
- Implement Google Sheets client using service account secret.
- Update docs with service account setup instructions.

### Phase 3 – Owner Notification Flow
- Integrate messaging layer to send owner alert using `flows/booking.json` values.
- Generate single-use tokens stored in KV.
- Embed accept/deny links with tokens.
- Add Resend tags / subject prefixes for owner email.

### Phase 4 – Owner Decision Handling
- Implement `/accepted` and `/denied` routes.
- Validate tokens, update Sheets status/audit trail.
- Send customer emails (accepted/denied templates) with driver contact info.
- Render confirmation HTML pages.

### Phase 5 – Observability & Extensibility
- Enrich logging (structured logs including transaction IDs).
- Document how to add new flows by editing JSON + messaging templates.
- Optionally expose metrics counters (accepted/denied counts) via logs.

### Phase 6 – Deliverability Hardening
- Verify sending domain authentication (SPF, DKIM) and introduce a staged DMARC policy.
- Support Resend features that improve inboxing (e.g., `reply_to`, BIMI image hooks, per-tag analytics).
- Provide guidance for monitoring spam placement and warming patterns in the ops docs.
- Evaluate alternate sender identities or routing if transactional mail volume increases.

## 10. Testing Strategy
- **Unit tests**: signature verification, rate limiter, token manager, Sheets client (mocked fetch), messaging payload generation.
- **Integration tests**: use Miniflare to simulate webhook POST and owner GET flows end-to-end with mocked Sheets/Resend.
- **Manual tests**: `npm run webhook:test` against local worker; confirm Resend success once domain verified; submit Framer form to staging worker.

## 11. Risks & Mitigations
- **Resend domain verification**: currently blocking live sends → mitigate by verifying domain or using Resend onboarding sender for tests.
- **Google Sheets quotas**: limit to two append calls per submission (primary + backup) and one update per decision; include exponential backoff on 429 responses.
- **Token leakage**: tokens stored with TTL and invalidated post-use; include rate limit on accept/deny endpoints to prevent brute force.
- **Framer retries**: ensure we only return `200` after Sheets writes succeed; otherwise return `500` so Framer retries.

## 12. Documentation Deliverables
- `docs/PRD.md` (this document) – kept up to date through development.
- `docs/README.md` – operational guide for running/testing.
- `flows/booking.json` – authoritative flow configuration with comments.
- Additional `docs/FLOWS.md` (future) to walk through creating new flow entries.

## 13. Open Tasks
- [ ] Populate `.dev.vars` with `GOOGLE_SHEET_ID_PRIMARY`, `GOOGLE_SHEET_ID_BACKUP` once provided.
- [ ] User to create Google service account, share Sheets with service-account email, and store JSON via `wrangler secret` (see `docs/GOOGLE_SHEETS_SETUP.md`).
- [ ] Remove legacy `EMAIL_FROM` usage in code once coordination/messaging layers are implemented.
- [ ] Decide on confirmation page branding/content beyond baseline text.
- [ ] Confirm whether rate limiting should also key off IP or just email.
